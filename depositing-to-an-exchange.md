# Confirming a Deposit to an Exchange

Deposits are made in several stages. 
One of the stages is to go through the [Exchange server](https://docs.flare.network/exchange/architecture/#architecture-of-an-exchange), which monitors for deposits and updates the Balances database. 
Run the code below to have the Exchange server listen for deposit transactions and confirm the deposits.

On a blockchain, multiple [validators](h[ttps://docs.flare.network/tech/glossary/](https://docs.flare.network/tech/validators/)) examine newly created transactions and come to an agreement about whether they are valid. 
When they are valid, they are added to a new block on the chain and identified by a one-way cryptographic algorithm, called a _hash_. 
The one-way hash prevents transactions from being reverted. 
[Blocks](https://docs.flare.network/tech/glossary/) are added to the [blockchain](https://docs.flare.network/tech/glossary/) in chronological order and it may take a few blocks for the hash to be completed.
To prevent problems, we confirm deposits several blocks back (five blocks in our code), when the blocks are most likely to be irreversible.

<!-- The [Architecture of an Exchange doc](https://docs.flare.network/exchange/architecture/) says, "To avoid problems, the Exchange should only act on transactions appearing on blocks old enough for the chance of them being reverted to be negligible."  Is this doc referring to the fact that blocks are irreversible except in the case of a severe attack when an ecosystem might agree to fork. Am I on the right track? 
I have never heard of a period where they could possibly be reverted, so I'm imagining that is the brief moment waiting for the cryptographic hash to be in place, yes?  -->

Newly submitted deposits to our receiving address are labeled "pending."
After five blocks have been created, valid deposits are labeled "confirmed."

Run the javascript below to see pending and confirmed transactions and which block number they were added to.

<!-- I don't think this article should be a primer on blockchain, so I limited blockchain explanation to only what they need to know for this procedure. Ideally, we would have high-level blockchain concepts so we don't have to repeat the concepts for every article that they apply to. 
The existing glossary definitions are part of that. 
Here are a few more definitions that I recommend adding to the glossary: 

| Term | Description |
| ----------- | ----------- |
| address | The address of a wallet where assets can be stored.
Represented by a hash. |
| block header | Data about the block, including a timestamp of when the block was a created, a hash representing the address of the previous block, and a Merkle root hash (a cryptographic hash of all of the transactions included in the block) |
| block number | Blocks are numbered sequentially in chronological order of creation |
| hash | An output of a string of a fixed size derived from the transformation of data of any length. 
`tx.hash` is the hash of the transaction.
It is generated by a one-way cryptographic algorithm, for which the original data cannot be retrieved by decryption.
Hashing stores passwords and prevents fraudulent transactions and double spending in blockchain. |
| node | A programmed participant in the network that can interact with other nodes.
Each node has different responsibilities, such as client or validator. |
-->

## One-Time Setup

1. Install [node.js](https://nodejs.org/en/download/). 
On the command line, run `node -v`  to check your installation.

2. Clone the Flare repository: 

`git clone https://github.com/flare-foundation/flare.git
cd flare`

See [the Flare repository on GitHub](https://github.com/flare-foundation/flare).

<!-- The Architecture page says "Your own instance with the test server" Is this relevant here or should we just stick to running in the terminal? -->

3. Install the web3.js library: 

`npm install web3`

See [Adding web3.js](https://web3js.readthedocs.io).

4. Build Flare with this script:

`./scripts/build.sh`

## Run the Code

1. `cd` to `flare`

2. Run the code: 

<!-- How do they run this file? I've seen people run files in the cli, but I don't know how to do it. I created a file and ran `npm run confirm-deposit.js`, but it didn't work. ->

The following code:

* Sets up the deposit by instantiating `web3`, assigning the endpoint URL, and assigning the `receivingAddress`
* Subscribes to 'pending transactions` to listen for deposit transactions and, if they are sent to the receiving address, labels them as "pending."
* Subscribes to 'newBlockHeaders` to get a block that is five blocks back from the block with the pending transactiions and labels it as "confirmed."
 
<!-- Since multiple transactions may be added to a block at a time, are we marking 1 pending transaction at at time, and then the entire set (1 or more) of confirmed transactions in a block? --> 

<!-- "Use your own node URL": They can test it as is, yes? Their own node URL would be for actual run time, yes? -->

```javascript
// You must have web3 installed 
const Web3 = require('web3');

// Test this code on the Coston testnet. Use your own node URL for actual runtime.
// https://docs.flare.network/dev/reference/coston-testnet/
const web3 = new Web3("wss://coston-api.flare.network/ext/bc/C/ws");

// This is the testnet receiving address. Use your receiving wallet address for actual runtime.
const receivingAddress = "0x947c76694491d3fD67a73688003c4d36C8780A97";

// Monitor for newly submitted deposit transactions.
web3.eth.subscribe("pendingTransactions")
// When a new transaction hash is received...
.on("data", async (transactionHash) => {
    // retrieve the transaction.
    let tx = await web3.eth.getTransaction(transactionHash);
    // If it is directed to our address...
    if (tx.to === receivingAddress) {
        // mark it as pending.
        console.log("Transaction", tx.hash, "is pending");
    }
}).on("error", console.error);

// Retrieve blocks 5 blocks back for confirmation.
web3.eth.subscribe("newBlockHeaders")
// When a new block has been produced...
.on("data", async (blockHeader) => {
    // retrieve a block old enough to be considered confirmed.
    let block = await web3.eth.getBlock(blockHeader.number - 5);

    // Get all of its transactions.
    block.transactions.forEach(async (transactionHash) => {
        // Retrieve the transaction...
        let tx = await web3.eth.getTransaction(transactionHash);
        // If it is directed to our address...
        if (tx.to === receivingAddress) {
            // mark it as confirmed.
            console.log("Transaction", tx.hash,
                "is confirmed in block", block.number);
        }
    });
}).on("error", console.error);
```
<!-- Do we have more information on possible error codes, such as Transaction Status](https://github.com/flare-foundation/multi-chain-client/blob/main/docs/definitions/transaction-status.md) -->

### Outcome

You can see which transactions are pending and which are confirmed and the block number they are in.

For example,

```javascript
Transaction 0xc3f3836b9fbe867d460b70258793e6601e4ffcb7f44203e8f40aca995ec21feb is pending
Transaction 0xc3f3836b9fbe867d460b70258793e6601e4ffcb7f44203e8f40aca995ec21feb is confirmed in block 4305057
```

The server is ready to move on to the next step: Check the wallet address to find the user account it belongs to.

