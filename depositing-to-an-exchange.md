# Depositing to an Exchange

To deposit to an Exchange, enable the [Exchange server](https://docs.flare.network/exchange/architecture/#architecture-of-an-exchange) to monitor and discover submitted transactions and make sure they are unlikely to be reverted.

Availability of cryptocurrency for a deposit needs to be verified on a blockchain just as availability of fiat currency needs to be verified for a bank.
However, making sure it is "unlikely to be reverted" is blockchain-specific.
On a blockchain, validators examine newly created transactions and could revert them.
Once a set of transactions is validated and added to a block, the block is identified by a one-way cryptographic algorithm and transactions cannot be reverted.
Because of the temporary instability during validation, it is more reliable to confirm deposits that are several blocks back, for example, five blocks back.

While the validators are reaching agreement, the Exchange server labels a deposit "pending."
Once the validators agree that the deposit is legitimate and add it to a block, the Exchange server labels it "confirmed."

Run the javascript below to see pending transactions and confirmed transactions with the block number they were added to.

<!-- Instead of having these in this article, we may want to link to the glossary and add any terms not in the glossary. We may want to consider some high-level blockchain articles that apply to all types of transactions and link to them. -->

<!-- Here are some definitions of terms that will help you understand the process and the code below. 

| Term | Description |
| ----------- | ----------- |
| address | The address of a wallet where assets can be stored.
Represented by a hash. |
| block | A unit of the blockchain.
For performance reasons, blockchains do not process transactions one by one.
Instead, transactions are grouped together in blocks which are then validated by the consensus algorithm. |
| blockchain | A digital ledger storing data and transactions on a distributed network of computers to make it more robust. |
| block header | Data about the block, including a timestamp of when the block was a created, a hash representing the address of the previous block, a Merkle root hash (a cryptographic hash of all of the transactions included in the block) |
| block number | Blocks are numbered sequentially in chronological order of creation |
| consensus | Instead of having an intermediary representing a centralized bank, a decentralized blockchain is validated by members with that responsibility. |
| Coston | The name given to the Flare public test network launched in January 2021, in remembrance of a great inventor, Martha J. Coston (1826-1904). |
| hash | An output of a string of a fixed size derived from the transformation of data of any length. `tx.hash` is the hash of the transaction.
It is generated by a one-way cryptographic algorithm, for which the original data cannot be retrieved by decryption.
Hashing stores passwords and prevents fraudulent transactions and double spending in blockchain.|
| node | A programmed participant in the network that can interact with other nodes.
Each node might have different responsibilities such as client or validator. |
| testnet |The computer network that supports a blockchain in its development stage. It is intended for testing purposes and should not store valuable assets, as its contents might be deleted (purposely or by accident) at any time.
Flare's testnet is called Coston. |
| transaction | An entry on the distributed ledger, once validated cannot be reverted.
It can be a movement of funds between two accounts, or the execution of a contract, for example. `tx`|
| transactionHash | A name derived by cryptographic hashing.
A change in the data of a block, i.e., a transaction, creates a new block with a new hash. |
| validator |A validator node is a machine connected to a blockchain network that verifies transactions and emits a vote.
When there is a quorum among all validators regarding a given block of transactions, they are accepted into the blockchain. |
-->

## One-Time Setup

1. Install [node.js](https://nodejs.org/en/download/). On the command line, run `node -v`  to check your installation.

<!-- Your own instance with the test server? -->

2. Clone the Flare repository: <!-- see https://github.com/flare-foundation/flare -->

`git clone https://github.com/flare-foundation/flare.git
cd flare`

3. Build Flare with this script:

`./scripts/build.sh`

## Run the Code

1. `cd` to < the cloned flare repository >

2. Run a node: `scripts/createLocal` <!-- ? -->

Leave this node running on a separate terminal while running the code.

### Discover Newly Submitted Transactions

To discover newly submitted transactions, subscribe to the `pending transactions` event.

Use your own node URL (See https://docs.flare.network/dev/reference/coston-testnet/) and your own wallet address to run this code:

<!-- Do I want to change any comments? -->

```javascript
// https://web3js.readthedocs.io
const Web3 = require('web3');

// Use your own node URL
// https://docs.flare.network/dev/reference/coston-testnet/
const web3 = new Web3("wss://coston-api.flare.network/ext/bc/C/ws");

// Use your receiving wallet address
const receivingAddress = "0x947c76694491d3fD67a73688003c4d36C8780A97";

web3.eth.subscribe("pendingTransactions")
.on("data", async (transactionHash) => {
    // New transaction hash received.
    // Retrieve the actual transaction.
    let tx = await web3.eth.getTransaction(transactionHash);
    // If it is directed to our address...
    if (tx.to === receivingAddress) {
        // Mark it as pending.
        console.log("Transaction", tx.hash, "is pending");
    }
}).on("error", console.error);
```

#### Outcome

In the console log, you can see which transactions were discovered and are pending.

For example,

```javascript
Transaction 0xc3f3836b9fbe867d460b70258793e6601e4ffcb7f44203e8f40aca995ec21feb is pending
```

### Verify that Transactions Are Unlikely to be Reverted

To ensure that blocks are old enough to be unlikely to be reverted, run this code to subscribe to the `newBlockHeaders` event and examine transactions 5 blocks back.

```javascript
web3.eth.subscribe("newBlockHeaders")
.on("data", async (blockHeader) => {
    // New block has been produced.
    // Retrieve a block old enough to be considered confirmed.
    let block = await web3.eth.getBlock(blockHeader.number - 5);

    // Get all its transactions.
    block.transactions.forEach(async (transactionHash) => {
        // Retrieve the actual transaction.
        let tx = await web3.eth.getTransaction(transactionHash);
        // If it is directed to our address...
        if (tx.to === receivingAddress) {
            // Mark it as confirmed.
            console.log("Transaction", tx.hash,
                "is confirmed in block", block.number);
        }
    });
}).on("error", console.error);
```

#### Outcome

In the console log, you can see which transactions were confirmed and which block number they are in.

For example,

```javascript
Transaction 0xc3f3836b9fbe867d460b70258793e6601e4ffcb7f44203e8f40aca995ec21feb is confirmed in block 4305057
```

<!-- Is there more we want to say about error codes. See [Transaction Status](https://github.com/flare-foundation/multi-chain-client/blob/main/docs/definitions/transaction-status.md) for some error handling messages. -->
